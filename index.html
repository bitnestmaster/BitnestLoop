<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BitnestLoop ‚Äî Dashboard</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: #0b1020; color: #e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px 16px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); border-radius: 16px; padding: 16px; margin: 14px 0; box-shadow: 0 12px 30px rgba(0,0,0,0.25); }
    h1 { margin: 0 0 6px; font-size: 34px; letter-spacing: 0.2px; }
    .muted { color: rgba(233,238,252,0.70); font-size: 14px; line-height: 1.35; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button {
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color: #e9eefc;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .05s ease, background .15s ease;
    }
    button:hover { background: rgba(255,255,255,0.12); }
    button:active { transform: translateY(1px); }
    button.primary { background: rgba(60, 255, 180, 0.16); border-color: rgba(60, 255, 180, 0.35); }
    button.primary:hover { background: rgba(60, 255, 180, 0.22); }
    code { background: rgba(255,255,255,0.10); padding: 2px 8px; border-radius: 999px; }
    .kv { display: grid; grid-template-columns: 160px 1fr; gap: 8px 10px; margin-top: 10px; }
    .k { color: rgba(233,238,252,0.65); }
    .v { word-break: break-all; }
    .status { padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); }
    .ok { border-color: rgba(60, 255, 180, 0.35); }
    .warn { border-color: rgba(255, 210, 90, 0.35); }
    .bad { border-color: rgba(255, 90, 120, 0.35); }
    .small { font-size: 13px; }
    .spacer { height: 6px; }
    .footer { margin-top: 18px; font-size: 12px; color: rgba(233,238,252,0.55); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BitnestLoop</h1>
    <div class="muted">Connect ‚Üí BSC pr√ºfen ‚Üí Contract-Infos lesen (safe/read-only).</div>

    <div class="card">
      <div class="row">
        <button id="btnConnect" class="primary">ü¶ä Connect Wallet</button>
        <button id="btnRefresh">üîÑ Refresh</button>
        <button id="btnSwitch">üåê Zu BSC wechseln</button>
      </div>
      <div class="spacer"></div>
      <div id="status" class="status small">Status: nicht verbunden</div>

      <div class="kv">
        <div class="k">Account</div><div class="v" id="account">-</div>
        <div class="k">ChainId</div><div class="v" id="chain">-</div>
        <div class="k">Contract</div><div class="v"><code id="contractAddr">-</code></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">Contract Infos</h3>
      <div class="muted">Wird nach erfolgreichem Connect aus dem Contract gelesen.</div>
      <div class="kv">
        <div class="k">owner()</div><div class="v" id="owner">-</div>
        <div class="k">paused()</div><div class="v" id="paused">-</div>
        <div class="k">TREASURY()</div><div class="v" id="treasury">-</div>
        <div class="k">USDC()</div><div class="v" id="usdc">-</div>
        <div class="k">USDT()</div><div class="v" id="usdt">-</div>
      </div>
    </div>

    <div class="footer">
      Tipp: Wenn ‚ÄúConnect‚Äù sofort abbricht, liegt es fast immer an: falschem Browser-Profil, MetaMask gesperrt, oder Seite nicht √ºber https/http.
      Auf Mobile bitte im Wallet-Browser √∂ffnen.
    </div>
  </div>

  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // === Konfiguration ===
    const EXPECTED_CHAIN_ID = 56; // BSC Mainnet
    const CONTRACT_ADDRESS = "0x61bF4DAE189C62344Df1E9802B5338C196d1E26B";

    // ABI (aus deiner Nachricht)
    const ABI = [
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
      {"anonymous":false,"inputs":[
        {"indexed":true,"internalType":"address","name":"token","type":"address"},
        {"indexed":true,"internalType":"address","name":"from","type":"address"},
        {"indexed":true,"internalType":"address","name":"to","type":"address"},
        {"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}
      ],"name":"Collected","type":"event"},
      {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],
        "name":"collectUSDC","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"from","type":"address"}],
        "name":"collectUSDCAll","outputs":[{"internalType":"uint256","name":"collected","type":"uint256"}],
        "stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],
        "name":"collectUSDT","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"from","type":"address"}],
        "name":"collectUSDTAll","outputs":[{"internalType":"uint256","name":"collected","type":"uint256"}],
        "stateMutability":"nonpayable","type":"function"},
      {"anonymous":false,"inputs":[
        {"indexed":true,"internalType":"address","name":"oldOwner","type":"address"},
        {"indexed":true,"internalType":"address","name":"newOwner","type":"address"}
      ],"name":"OwnershipTransferred","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"isPaused","type":"bool"}],
        "name":"Paused","type":"event"},
      {"inputs":[{"internalType":"bool","name":"p","type":"bool"}],
        "name":"setPaused","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],
        "name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],
        "stateMutability":"view","type":"function"},
      {"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],
        "stateMutability":"view","type":"function"},
      {"inputs":[],"name":"TREASURY","outputs":[{"internalType":"address","name":"","type":"address"}],
        "stateMutability":"view","type":"function"},
      {"inputs":[],"name":"USDC","outputs":[{"internalType":"address","name":"","type":"address"}],
        "stateMutability":"view","type":"function"},
      {"inputs":[],"name":"USDT","outputs":[{"internalType":"address","name":"","type":"address"}],
        "stateMutability":"view","type":"function"}
    ];

    // === UI helpers ===
    const $ = (id) => document.getElementById(id);

    function setStatus(text, kind="") {
      const el = $("status");
      el.textContent = "Status: " + text;
      el.classList.remove("ok","warn","bad");
      if (kind) el.classList.add(kind);
    }

    $("contractAddr").textContent = CONTRACT_ADDRESS;

    let provider, signer, contract;

    function hasEthereum() {
      return typeof window.ethereum !== "undefined";
    }

    async function connect() {
      if (!hasEthereum()) {
        setStatus("Keine Wallet gefunden (MetaMask Extension?)", "bad");
        return null;
      }

      try {
        // Wichtig: eth_requestAccounts (nicht eth_accounts)
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        const accounts = await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        const addr = accounts?.[0] || await signer.getAddress();
        $("account").textContent = addr;

        const net = await provider.getNetwork();
        $("chain").textContent = String(net.chainId);

        if (net.chainId !== EXPECTED_CHAIN_ID) {
          setStatus(`Verbunden, aber falsches Netzwerk (chainId ${net.chainId}). Bitte BSC (56) w√§hlen.`, "warn");
        } else {
          setStatus("Verbunden ‚úÖ (BSC Mainnet)", "ok");
        }

        return { addr, chainId: net.chainId };
      } catch (e) {
        // 4001 = user rejected request
        if (e && e.code === 4001) setStatus("Abgebrochen (User hat abgelehnt)", "bad");
        else setStatus("Connect fehlgeschlagen: " + (e?.message || e), "bad");
        console.error(e);
        return null;
      }
    }

    async function refresh() {
      if (!contract) {
        const c = await connect();
        if (!c) return;
      }

      try {
        const net = await provider.getNetwork();
        $("chain").textContent = String(net.chainId);

        // Read-only calls
        const [owner, paused, treasury, usdc, usdt] = await Promise.all([
          contract.owner(),
          contract.paused(),
          contract.TREASURY(),
          contract.USDC(),
          contract.USDT()
        ]);

        $("owner").textContent = owner;
        $("paused").textContent = String(paused);
        $("treasury").textContent = treasury;
        $("usdc").textContent = usdc;
        $("usdt").textContent = usdt;

        if (net.chainId === EXPECTED_CHAIN_ID) setStatus("Infos geladen ‚úÖ", "ok");
        else setStatus("Infos geladen, aber Netzwerk ist nicht BSC (56).", "warn");
      } catch (e) {
        setStatus("Refresh fehlgeschlagen: " + (e?.data?.message || e?.message || e), "bad");
        console.error(e);
      }
    }

    async function switchToBSC() {
      if (!hasEthereum()) {
        setStatus("Keine Wallet gefunden", "bad");
        return;
      }

      try {
        // Versucht auf BSC umzuschalten; falls nicht vorhanden: hinzuf√ºgen
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: "0x38" }] // 56 in hex
        });
        setStatus("Zu BSC gewechselt ‚úÖ", "ok");
        await refresh();
      } catch (e) {
        // 4902 = chain not added
        if (e && e.code === 4902) {
          try {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: "0x38",
                chainName: "BNB Smart Chain",
                nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
                rpcUrls: ["https://bsc-dataseed.binance.org/"],
                blockExplorerUrls: ["https://bscscan.com/"]
              }]
            });
            setStatus("BSC hinzugef√ºgt & gewechselt ‚úÖ", "ok");
            await refresh();
          } catch (e2) {
            setStatus("BSC hinzuf√ºgen fehlgeschlagen: " + (e2?.message || e2), "bad");
            console.error(e2);
          }
        } else if (e && e.code === 4001) {
          setStatus("Abgebrochen (Netzwerkwechsel abgelehnt)", "bad");
        } else {
          setStatus("Netzwerkwechsel fehlgeschlagen: " + (e?.message || e), "bad");
          console.error(e);
        }
      }
    }

    // Buttons
    $("btnConnect").addEventListener("click", async () => { await connect(); });
    $("btnRefresh").addEventListener("click", async () => { await refresh(); });
    $("btnSwitch").addEventListener("click", async () => { await switchToBSC(); });

    // Auto-update on changes
    if (hasEthereum()) {
      window.ethereum.on("accountsChanged", () => location.reload());
      window.ethereum.on("chainChanged", () => location.reload());
    }
  </script>
</body>
</html>
